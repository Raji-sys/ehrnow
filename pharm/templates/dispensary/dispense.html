{% extends 'base.html' %}
{% load static %}

{% block title %}DISPENSARY{% endblock %}

{% block content %}
<div class="">
    <div class="uk-overlay rounded-3xl bg-white uk-position-center mt-4">
        <section class="text-center border-cyan-700 p-4 m-2">
            {% for message in messages %}
            <div class="mt-2">
                <div class="uk-alert-success rounded-2xl text-sm" uk-alert>
                    <a href class="uk-alert-close font-bold" uk-close></a>
                    <p class="text-green-700 font-semibold uppercase">{{ message }}</p>
                </div>
            </div>
            {% endfor %}
        </section>

        {% if form.non_field_errors %}
        <div class="uk-alert-danger block text-xs uppercase text-rose-700 rounded-xl" uk-alert>
            <a href class="uk-alert-close font-bold" uk-close></a>
            <p>{{ form.non_field_errors }}</p>
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="text-xs">
            {% csrf_token %}
            <div class="mb-2 uppercase text-cyan-900 px-10">
                <p class="text-green-900 text-sm font-bold text-center border-b border-green-700">DISPENSARY FORM</p>
                {% for field in form.visible_fields %}
                <div class="md:flex md:flex-row grid grid-cols-4 md:gap-6 p-4">
                    <div>
                        <div>
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        </div>
                        <div>
                            {{ field }}
                            {% if field.errors %}
                            <div class="text-red-500 text-xs italic">
                                {% for error in field.errors %}
                                <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="gap-4 flex justify-center align-middle">
                <input type="submit" value="dispense" class="focus:opacity-10 uppercase focus:border-green-900 hover:bg-white hover:text-green-600 hover:border-2 hover:border-green-600 bg-green-700 text-white py-4 px-8 rounded shadow-lg hover:shadow-xl">
            </div>
        </form>
    </div>
</div>

<script>
    function initializePage() {
        function load_drugs(categoryField) {
            const categoryId = categoryField.value;
            const form = categoryField.closest('.md\\:flex');
            const drugSelect = form.querySelector('[name$="-drug"]');
            const url = `/pharm/get_drugs_by_category/${categoryId}/`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    drugSelect.innerHTML = ''; // Clear existing options
                    data.drugs.forEach(drug => {
                        const option = document.createElement('option');
                        option.value = drug.id;
                        option.text = drug.name;
                        drugSelect.add(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        document.querySelectorAll('select[name$="-category"]').forEach(categoryField => {
            categoryField.addEventListener('change', function() {
                load_drugs(this);
            });
        });
    }

    window.addEventListener('load', initializePage);
</script>
{% endblock %}